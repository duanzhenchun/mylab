{% extends "base.html" %}

{% block head%}
<script type="text/javascript" src="/static/js/jquery.min.js"></script>
<script type="text/javascript" src="/static/js/navigate.js"></script>
<script type="text/javascript">
$(document).ready(function() {
function selectText(){
    if(document.selection){
        return document.selection.createRange().text;// IE
    }else{
        return 	window.getSelection().toString(); //标准
    }
}
function change_word(w, unkown, refresh){
    $.ajax({
        type: "POST",
        url: '../word_mark',
        data:{ w:w, unkown:unkown,
                curpage:{{curpage}}, 
                page_size:{{page_size}} 
            },
        success: function(data){
            if (refresh){
            var ph='<p class="p_txt">';
            txt = ph + data.lines.join('</p>'+ph)+ '</p>';
                $("#div_txt").html(txt);
            }
        }
    });
}

function unkown_html(k, v){
    return "<div><span class='personal_word'>" + k + "</span> : " + v[2] + "</div>" +
           "<div class='dt'>" + v[1] + "</div>" +
           "<div>" + v[0] + "</div>";
}
function repeat_word(w){
    $.ajax({
        type: "POST",
        url: '../word_repeat',
        data:{w:w}, 
        success: function(data){
            var txt='';
            $.each(data, function(k, v){ 
                txt += unkown_html(k,v);
            });
            $("#div_unkown_txt").html(txt);
        }
    });
}

function like_word(s) {
    return /^[\w\d]+$/i.test(s);
}

$(".word_span").live("click", function (){ // live response everytime
    w = $(this).text();
    yn = confirm("生词? "+w)
    change_word(w, yn, !yn);
});

$(".personal_word").live("click", function (){ 
    w = $(this).text();
    yn = confirm("repeat? "+w)
    repeat_word(w);
});


$("#div_txt").mouseup(function(){
    var s = selectText().trim();
    if (s.length>0 & like_word(s)) {
        if(confirm("生词? "+s)) {
            change_word(s, true, true);
        }
    } 
});
});

$(document).keydown(function(event){  
   event = event || window.event;
   if(event.keyCode==37){ 
   {% if pagelist.has_previous %}
   location.href = "?{{ addr|safe }}={{ pagelist.previous_page_number }}";
   {% endif %}
   };
   if(event.keyCode==39){ 
   {% if pagelist.has_next %}
   location.href = "?{{ addr|safe }}={{ pagelist.next_page_number }}";
   {% endif %}
   };
});
</script>
{% endblock %}

{% block left %}
<a href="./upload">upload</a>
<br/>
<a href="./personal">personal</a>
{% endblock %}

{% block middle%}
    {% for line in lines %}
    <p class='p_txt'>{{line|safe}}</p>
    {% endfor %}
{% endblock %}

{% block right %}
<div id="div_unkown_txt">
{% for k, v in unkown.items %}
    <div>
    <span class='personal_word'>{{k}}</span> : {{v.2}}
    </div>
    <div class='dt'>{{v.1}}</div>
    <div>{{v.0|safe}}</div> 
{% endfor %}
</div>
{% endblock %}

{% block footer %}
{% include "nav.html" %}
{% endblock %}
